<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>服务接口管理系统</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <script type="text/javascript" src="../lib/vue/jquery.min.js"></script>
    <script src="../lib/vue/jquery-ui.js"></script>
    <script type="text/javascript" src="../lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
    <script type="text/javascript" src="../js/global.js"></script>
    <script type="text/javascript" src="../js/store.js"></script>
    <script type="text/javascript" src="../js/cookies.js"></script>
    <script src="../lib/vue/vue.min.js"></script>
    <script src="../lib/vue/axios.min.js"></script>
    <style>
        tr {
            cursor: pointer;
        }

        .layui-table-cell {
            padding: 0 2px;
        }
        .req-manager-button a{
            font-size: 14px;
            margin-left:10px;
            margin-right:10px;
        }
        .req-manager-button a:hover{
            color: red;
        }

        .req-ul li {
            margin-top: 1px;
        }
    </style>
    <script>
        updateApiIndex = function (e, ui) {
            let apiDataArray = vm.apiDataList
            let tempArray = new Array()
            let temp
            //更新后的列表
            let eachArray = $('td.index', ui.item.parent())
            eachArray.each(function (i, item) {
                $(this).html(i + 1)
                var id = item.parentElement.lastElementChild.firstElementChild.firstElementChild.innerText
                temp = apiDataArray[i]
                if (temp.myId === parseInt(id)) {
                    tempArray[i] = apiDataArray[i]
                } else {
                    for (var j = 0; j < apiDataArray.length; j++) {
                        if (apiDataArray[j].myId === parseInt(id)) {
                            tempArray[i] = apiDataArray[j]
                            break
                        }
                    }
                }
            });
            vm.apiDataListUpdate = tempArray
        };
        

        $(document).ready(function () {
            var fixHelperModified = function (e, tr) {
                    var $originals = tr.children();
                    var $helper = tr.clone();
                    $helper.children().each(function (index) {
                        $(this).width($originals.eq(index).width())
                    });
                    return $helper;
                },
                updateIndex = function (e, ui) {
                    $('td.index', ui.item.parent()).each(function (i) {
                        $(this).html(i + 1);
                    });
                };
            $("#sort tbody").sortable({
                helper: fixHelperModified,
                stop: updateApiIndex
            }).disableSelection();
        });
    </script>
</head>

<body>
<div id="case-detail">
    <div class="x-body layui-anim layui-anim-up" style="padding-top: 0px">
        <div style="margin-top: 5px;">
            <a href="javascript:;" @click="addApi"
               class="layui-btn  layui-btn-sm layui-btn-normal">添加接口</a>
            <a href="javascript:;" @click="save($event)"
               class="layui-btn  layui-btn-sm layui-btn-normal">保存</a>
            <a href="javascript:;" @click="executeTestGroup"
               class="layui-btn  layui-btn-sm layui-btn-danger">执行测试</a>
        </div>
        <table class="layui-table" id="sort">
            <colgroup>
                <col width="60">
                <col width="280">
                <col width="280">
                <col width="105">
                <col width="180">
                <col>
            </colgroup>
            <thead>
            <tr>
                <th>序号</th>
                <th>接口编号</th>
                <th>接口名称</th>
                <th>版本号</th>
                <th>取参方式</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="(item,index) in apiDataList">
                <td class="index">{{index+1}}</td>
                <td>{{item.serviceCode}}</td>
                <td>{{item.serviceName}}</td>
                <td>{{item.versionNo}}</td>
                <td>{{item.requestParamFlag | convertParamType}}</td>
                <td>
                    <div class="req-manager-button">
                        <div style="display: none">{{item.myId}}</div>
                        <a href="javascript:;"><i class="iconfont">&#xe6fd;</i></a>
                        <a href="javascript:;"
                           @click='editApi(index,$event)'><i
                                class="iconfont">&#xe69e;</i>修改</a>
                        <a href="javascript:;"
                           @click='removeApi(index,$event)'><i
                                class="iconfont">&#xe69d;</i>删除</a>
                    </div></td>
            </tr>
            </tbody>
        </table>
        <table id="logList"></table>
    </div>
    <input hidden id="groupArray" type="text">
    <input hidden id="apiData" type="text">
</div>
<script>
    function addApiData (index) {
        let apiData = JSON.parse($('#apiData').val())
        apiData.projectId=vm.projectId
        apiData.caseConfId=vm.caseId
        apiData.myId = parseInt(apiData.myId)
        if(index !== -1){
            vm.apiDataList.push(apiData)
            vm.apiDataList[index] = vm.apiDataList[vm.apiDataList.length-1]
            vm.apiDataList.splice(vm.apiDataList.length - 1,1)
        }else {
            apiData.myId =vm.nextId
            vm.apiDataList.push(apiData)
            vm.nextId++
        }
        //用完清空数据
        $('#apiData').val('')
    }

</script>
<script>
    let vm = new Vue({
        el: '#case-detail',
        data () {
            return {
                caseId:0,
                groupId:0,
                projectId:0,
                apiData:'',
                groupArray:[],
                nextId: 0,
                apiDataList:[],
                apiDataListUpdate:[]
            }
        },
        filters:{
            convertParamType(data){
                return getrequestParamTypeArray[data]
            }
        },
        beforeMount(){
            this.caseId = getUrlKey('id')
            this.groupId = getUrlKey('groupId')
            this.projectId = getUrlKey('projectId')
            axios.get(_hostUrl+'/test/configApis/'+this.caseId).then(response =>{
                if (response.data.responseCode == 200) {
                    this.apiDataList = response.data.data
                    for (var i = 0; i < this.apiDataList.length; i++) {
                        this.apiDataList[i].myId = this.nextId
                        this.apiDataList[i].id = null
                        this.nextId++
                    }
                }
            })
            axios.get(_hostUrl + '/groups/' + this.projectId).then(response => {
                if (response.data.responseCode == 200) {
                    this.groupArray = response.data.data.resultList
                    $('#groupArray').val(JSON.stringify(this.groupArray))
                }

            })
        },
        methods:{
            addApi(){
                x_admin_show('添加接口', './case-api-add.html', 600, 400)
            },
            save(e){
                e.stopPropagation()
                e.preventDefault()
                let layer
                layui.use(['layer'],function () {
                    layer = layui.layer
                })
                //为空说明没有进行过移动，直接用原列表
                if(this.apiDataListUpdate.length === 0){
                    this.apiDataListUpdate = this.apiDataList
                }
                axios({
                    method: "post",
                    url: _hostUrl + '/test/configApi',
                    data: {
                        caseConfId :this.caseId,
                        apiDataList: JSON.stringify(this.apiDataListUpdate)
                    }
                }).then((res) => {
                    if(res.data.responseCode === 201){
                        //登记成功
                        layer.msg('操作成功',{
                            icon:1,
                            timeout:2000
                        })
                    }else{
                        layer.msg(res.data.responseMsg, {
                            icon: 2,
                            timeout: 2000
                        })
                    }
                })


            },
            executeTestGroup(){

            },
            removeApi (index, e){
                e.stopPropagation()
                e.preventDefault()
                this.apiDataList.splice(index,1)
                this.nextId--
                //重新排序
                for (var i = 0; i < this.apiDataList.length; i++) {
                    this.apiDataList[i].myId = i
                }
            },
            editApi (index, e){
                e.stopPropagation()
                e.preventDefault()
                $('#apiData').val(JSON.stringify(this.apiDataList[index]))
                x_admin_show('修改接口', './case-api-edit.html?index='+index, 600, 400)
            }
        }
    })
</script>
</body>

</html>