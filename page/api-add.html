<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>服务接口管理系统</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
    <script type="text/javascript"
            src="../lib/vue/jquery.min.js"></script>
    <script src="../lib/vue/jquery-ui.js"></script>
    <script type="text/javascript" src="../lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
    <script type="text/javascript" src="../js/global.js"></script>
    <script type="text/javascript" src="../js/store.js"></script>
    <script type="text/javascript" src="../js/cookies.js"></script>
    <script src="../lib/vue/vue.min.js"></script>
    <script src="../lib/vue/axios.min.js"></script>
    <style>
        tr {
            cursor: pointer;
        }
    </style>
    <script>
        $(document).ready(function () {
            var fixHelperModified = function (e, tr) {
                    var $originals = tr.children();
                    var $helper = tr.clone();
                    $helper.children().each(function (index) {
                        $(this).width($originals.eq(index).width())
                    });
                    return $helper;
                },
                updateIndex = function (e, ui) {
                    $('td.index', ui.item.parent()).each(function (i) {
                        $(this).html(i + 1);
                    });
                };
            $("#sort tbody").sortable({
                helper: fixHelperModified,
                stop: updateIndex
            }).disableSelection();
        });
    </script>
</head>

<body>
<div class="x-body layui-anim layui-anim-up" style="padding-top: 0px">
    <form class="layui-form">
        <div class="layui-tab layui-tab-brief">
            <ul class="layui-tab-title">
                <li class="layui-this">基本信息</li>
                <li>请求参数</li>
                <li>响应参数</li>
            </ul>
            <div class="layui-tab-content">
                <!--接口id-->
                    <div class="layui-form-item" hidden>
                        <input type="text" id="L_id" name="id"  class="layui-input">
                        <input type="text" id="L_projectId" name="projectId" class="layui-input">
                        <input type="text" id="L_contractId" name="contractId" class="layui-input">
                        <input type="text" id="L_groupId" name="groupId"  class="layui-input">
                    </div>
                <div class="layui-tab-item layui-show">
                    <div class="layui-form-item">
                        <label for="L_groupCode" class="layui-form-label" style="width: 100px">
                            <span class="x-red">*</span>所属分组
                        </label>
                        <div class="layui-input-inline" style="width: 300px;">
                            <select id="L_groupCode" name="groupCode" lay-filter="groupCode">
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="L_serviceCode" class="layui-form-label" style="width: 100px">
                            <span class="x-red">*</span>服务编号
                        </label>
                        <div class="layui-input-inline" style="width: 300px;">
                            <select id="L_serviceCode" name="serviceCode" lay-filter="serviceCode">
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="L_versionNo" class="layui-form-label" style="width: 100px">
                            <span class="x-red">*</span>版本号
                        </label>
                        <div class="layui-input-inline" style="width: 300px;">
                            <input type="text" id="L_versionNo" name="versionNo" required=""
                                   lay-verify="versionNo" class="layui-input">
                        </div>
                        <div class="layui-form-mid layui-word-aux">
                            <span class="x-red">*</span>直接填写版本号不需要"V"
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="L_serviceName" class="layui-form-label"
                               style="width: 100px">
                            <span class="x-red">*</span>服务名称
                        </label>
                        <div class="layui-input-inline" style="width: 300px;">
                            <input type="text" id="L_serviceName" name="serviceName" required=""
                                   lay-verify="serviceName" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                            <label class="layui-form-label" style="width: 100px">
                                业务规则
                            </label>
                        <div class="layui-input-inline" style="width: 500px;">
                            <textarea name="businessRole"
                                      class="layui-textarea"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">
                        </label>
                        <button class="layui-btn layui-btn-lg" lay-filter="add" lay-submit="">
                            保存
                        </button>
                    </div>
                </div>
                <div class="layui-tab-item">
                    <table class="layui-table" id="sort">
                        <colgroup>
                            <col width="150">
                            <col width="200">
                            <col>
                        </colgroup>
                        <thead>
                        <tr>
                            <th>昵称</th>
                            <th>加入时间</th>
                            <th>签名</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>贤心</td>
                            <td>2016-11-29</td>
                            <td>人生就像是一场修行</td>
                        </tr>
                        <tr>
                            <td>许闲心</td>
                            <td>2016-11-28</td>
                            <td>于千万人之中遇见你所遇见的人，于千万年之中，时间的无涯的荒野里…</td>
                        </tr>
                        <tr>
                            <td>许闲心1</td>
                            <td>2016-11-28</td>
                            <td>于千万人之中遇见你所遇见的人，于千万年之中，时间的无涯的荒野里…</td>
                        </tr>
                        <tr>
                            <td>许闲心2</td>
                            <td>2016-11-28</td>
                            <td>于千万人之中遇见你所遇见的人，于千万年之中，时间的无涯的荒野里…</td>
                        </tr>
                        <tr>
                            <td>许闲心3</td>
                            <td>2016-11-28</td>
                            <td>于千万人之中遇见你所遇见的人，于千万年之中，时间的无涯的荒野里…</td>
                        </tr>
                        <tr>
                            <td>许闲心4</td>
                            <td>2016-11-28</td>
                            <td>于千万人之中遇见你所遇见的人，于千万年之中，时间的无涯的荒野里…</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="layui-tab-item">
                </div>
            </div>
        </div>
    </form>
</div>
<script>
    var serviceArray;
    function getServiceCode (form) {
        $.get(_hostUrl + '/contracts/' + parseInt(getCookie('projectId')) + '/' + $('#L_groupId').val(), function (res) {
            if (res.responseCode == 200) {
                $("#L_serviceCode").find("option").remove();
                serviceArray = res.data
                for (var i = 0; i < serviceArray.length; i++) {
                    $('#L_serviceCode').append(new Option(serviceArray[i].serviceCode, serviceArray[i].serviceCode))// 下拉菜单里添加元素
                }
                //默认添加第一组数据
                $('#L_serviceCode').val(serviceArray[0].serviceCode)
                $('#L_contractId').val(serviceArray[0].id)
                $('#L_serviceName').val(serviceArray[0].serviceName)
                $('#L_versionNo').val(serviceArray[0].versionNo)
                form.render()
            }
        })
    }
    layui.use(['form', 'layer'], function () {
        $ = layui.jquery
        var form = layui.form
            , layer = layui.layer
        //获取选中的数据 进行格式转换，并加载到form表单中
        var groupString = parent.$('#groupArray').val()
        var groupArray = JSON.parse(groupString)
        for (var i = 0; i < groupArray.length; i++) {
            $('#L_groupCode').append(new Option(groupArray[i].name, groupArray[i].groupCode))// 下拉菜单里添加元素
        }
        //如果是复制的则需要初始化数据
        var editData = parent.$("#editApi").val();
        if (editData != '') {
            var editArray = JSON.parse(editData)
            loadJsonDataToForm(editArray)
        } else {
            $('#L_groupCode').val(groupArray[0].groupCode)
            $('#L_groupId').val(groupArray[0].id)
            $('#L_projectId').val(parseInt(getCookie('projectId')))
        }
        //根据groupId查询该组下的所有合约信息
        getServiceCode(form)
        form.render()
        //自定义验证规则
        form.verify({
            versionNo: function (value) {
                if (value.length < 1) {
                    return '版本号不可为空'
                }
            },
            serviceCode: function (value) {
                if (value.length < 1) {
                    return '服务编号不可为空'
                }
            },
            serviceName: function (value) {
                if (value.length < 1) {
                    return '服务名称不可为空'
                }
            }
        })

        //监控分组选择事件
        form.on('select(groupCode)', function (data) {
            $.each(groupArray, function (i, item) {
                if (item.groupCode == data.value) {
                    $('#L_groupId').val(item.id)
                    getServiceCode(form)
                    return
                }
            })
        })
        //监控分组选择事件
        form.on('select(serviceCode)', function (data) {
            $.each(serviceArray, function (i, item) {
                if (item.serviceCode == data.value) {
                    $('#L_serviceCode').val(item.serviceCode)
                    $('#L_contractId').val(item.id)
                    $('#L_serviceName').val(item.serviceName)
                    $('#L_versionNo').val(item.versionNo)
                    return
                }
            })
        })

        //监听提交
        form.on('submit(add)', function (data) {
            data.field.id = null
            $.post(_hostUrl + '/api', data.field, function (res) {
                if (res.responseCode == 201) {
                    layer.msg('添加接口成功', {
                        icon: 1,
                        time: 2000
                    }, function () {
                        // 获得frame索引
                        var index = parent.layer.getFrameIndex(window.name)
                        //关闭当前frame
                        parent.layer.close(index)
                        var table = parent.window.layui.table
                        table.reload('apiList', {
                            where: {
                                projectId: parseInt(getCookie('projectId'))
                                , groupId: data.field.groupId
                            }
                        })
                    })
                } else {
                    layer.msg(res.responseMsg)
                }
            })
            return false
        })

    })
</script>
</body>

</html>