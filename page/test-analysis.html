<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>服务接口管理系统</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <script type="text/javascript"
            src="../lib/vue/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
    <script type="text/javascript" src="../js/global.js"></script>
    <script type="text/javascript" src="../js/store.js"></script>
    <script type="text/javascript" src="../js/cookies.js"></script>
    <script src="../echarts/echarts-rel.js"></script>
    <script src="../lib/vue/vue.min.js"></script>
    <script src="../lib/vue/axios.min.js"></script>
    <style type="text/css">
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0
        }

        #timeCount, #successCount{
            width: 45%;
            height: 400px;
            border:1px solid gainsboro;
            float: left;
            margin-left: 20px;
        }
    </style>
</head>
<body>
<div style="width: 350px;margin-left: 20px;margin-top: 10px;margin-bottom: 5px;">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">统计周期</label>
            <div class="layui-input-block">
                <select name="timeCount" lay-filter="timeCountKey">
                    <option value="">全部</option>
                    <option value="0">近七天</option>
                    <option value="1">近一月</option>
                    <option value="2">近三月</option>
                </select>
            </div>
        </div>

    </form>
</div>
<div id="test-analysis" style="">
    <div id="successCount" style=""></div>
    <div id="timeCount" style=""></div>
</div>

<script type="text/javascript">
    layui.use(['form', 'layer'], function () {
        let form = layui.form
        form.on('select(timeCountKey)', function (data) {
            vm.getData(data.value)
        })
    })

</script>
<script>
    let vm = new Vue({
        el: '#test-analysis',
        data () {
            return {
                successData:[],
                timeData:{
                    maxTime: 0,
                    avgTime: 0,
                    minTime: 0
                },
                testInfo:{},
                mycharts:{}
            }
        },
        beforeMount () {
            this.testInfo.groupId = parseInt(getUrlKey('groupId'))
            this.testInfo.caseGroupId = parseInt(getUrlKey('caseGroupId'))
            this.testInfo.envId = parseInt(getUrlKey('envId'))
            this.testInfo.apiId = parseInt(getUrlKey('apiId'))
            this.testInfo.projectId = parseInt(getCookie('projectId'))
            this.getData('')
        },
        watch:{
            successData(){
                this.mycharts = echarts.init(document.getElementById('successCount'));  //初始化echarts实例
                this.drawSuccess();
            },
            timeData(){
                this.mycharts = echarts.init(document.getElementById('timeCount'));  //初始化echarts实例
                this.drawTime();
            }
        },
        methods: {
            getData (countType) {
                let url = _hostUrl + '/test/caseSingle/analysis?caseGroupId=' + this.testInfo.caseGroupId
                    + '&groupId=' + this.testInfo.groupId + '&envId=' + this.testInfo.envId
                    + '&apiId=' + this.testInfo.apiId
                    + '&projectId=' + this.testInfo.projectId+'&countType='+ countType
                //获取统计数据
                axios.get(url).then(response => {
                    if (response.data.responseCode == 200) {
                        this.successData = response.data.data.successData
                        this.timeData = response.data.data.timeData
                    }
                })
            },
            drawSuccess(){
                let option = {
                    color: ['#4cabce', '#e5323e'],
                    title: {
                        text: '接口测试成功/失败统计',
                        x: 'center'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: "{a} <br/>{b} : {c} ({d}%)"
                    },
                    legend: {
                        type: 'scroll',
                        orient: 'vertical',
                        left: 10,
                        top: 20,
                        bottom: 20,
                        data: ['成功', '失败']
                    },
                    series: [
                        {
                            name: '请求总数',
                            type: 'pie',
                            radius: '55%',
                            center: ['40%', '50%'],
                            label: {            //饼图图形上的文本标签
                                normal: {
                                    show: true,
                                    position: 'inner', //标签的位置
                                    textStyle: {
                                        fontWeight: 300,
                                        fontSize: 16    //文字的字体大小
                                    },
                                    formatter: '{c}'

                                }
                            },
                            data: this.successData,
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };
                this.mycharts.setOption(option);
            },
            drawTime () {
                let labelOption = {
                    normal: {
                        show: true,
                        position: 'top'
                    }
                };
               let option = {
                    color: ['#006699', '#4cabce', '#e5323e'],
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    legend: {
                        data: ['最大耗时', '平均耗时', '最小耗时']
                    },
                    toolbox: {
                        show: true,
                        orient: 'vertical',
                        left: 'right',
                        top: 'center',
                        feature: {
                            mark: {show: true},
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    calculable: true,
                    xAxis: [
                        {
                            type: 'category',
                            axisTick: {show: false},
                            data: ['执行耗时（ms）']
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    series: [
                        {
                            name: '最大耗时',
                            type: 'bar',
                            label: labelOption,
                            barWidth: 40,
                            data: [this.timeData.maxTime]
                        },
                        {
                            name: '平均耗时',
                            type: 'bar',
                            label: labelOption,
                            barWidth: 40,
                            data: [this.timeData.avgTime]
                        },
                        {
                            name: '最小耗时',
                            type: 'bar',
                            label: labelOption,
                            barWidth: 40,
                            data: [this.timeData.minTime]
                        }
                    ]
                };
                // 使用刚指定的配置项和数据显示图表。
                this.mycharts.setOption(option);
            }
        },
        mounted () {
            this.$nextTick(function () {
                this.mycharts = echarts.init(document.getElementById('successCount'));  //初始化echarts实例
                this.drawSuccess();
                this.mycharts = echarts.init(document.getElementById('timeCount'));  //初始化echarts实例
                this.drawTime();
            })
        }
    })
</script>
</body>
</html>
